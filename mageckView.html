<!DOCTYPE html>
<html lang="en">
  <head>
    <title>MAGeCK results viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.datatables.net/v/bs5/dt-1.13.4/b-2.3.6/b-colvis-2.3.6/b-html5-2.3.6/cr-1.6.2/sb-1.4.2/datatables.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css" integrity="sha384-b6lVK+yci+bfDmaY1u0zE8YYJt0TZxLEAFyYSLHId4xoVvsrQu3INevFKo+Xir8e" crossorigin="anonymous">
  </head>
  <body>
    <div
      id="mgkv-loading"
      class="position-absolute z-3 top-0 start-0 vh-100 vw-100 d-flex align-items-center justify-content-center bg-light"
    >
      <div class="me-3 spinner-border text-success" role="status"></div>
      <h3>Loading the application</h3>
    </div>
    <div id="main-container" class="container visually-hidden">
      <div class="row">
        <div class="col">
          <h1>
            MAGeCK results viewer
          </h1>
        </div>
        <div class="col d-flex align-items-center justify-content-end">
          <a href="https://github.com/CloXD/MAGeCK_view" target="_blank" class="icon-link link-dark fs-2">
            <i class="bi bi-github"></i>
          </a>
          </h1>
        </div>
      </div>
      
      <div class="row">
        <div class="col-12">
          <div class="px-2" id="mageckView"></div>
        </div>
      </div>
      <div
        class="row align-items-center justify-content-center"
        id="file_loader"
      >
        <div class="col-3">
          <h3>Input files</h3>
          <div class="mb-3">
            <label for="sgrna" class="form-label">sgRNAs counts (*.count.txt) </label>
            <input
              class="form-control mkgv-file-loader"
              type="file"
              data-type="sgrna"
            />
          </div>
          <div class="mb-3">
            <label for="geneSummary" class="form-label"
              >Test gene summary (*.gene_summary.txt)</label
            >
            <input
              class="form-control mkgv-file-loader"
              type="file"
              data-type="geneSummary"
            />
          </div>
          <div class="mb-3">
            <label for="sgrnaSummary" class="form-label">sgRNA summary (*.sgrna_summary.txt)</label>
            <input
              class="form-control mkgv-file-loader"
              type="file"
              data-type="sgrnaSummary"
            />
          </div>
          <div class="mb-3">
            <label for="libraryFile" class="form-label">sgRNA Library</label><br/>
            <div class="input-group">
              <input type="text" class="form-control" placeholder="Library Name" id="library-input-name">
              <input
                id="library-input-file"
                class="form-control"
                type="file"
                data-type="libraryFile"
              />
              <button class="btn btn-outline-primary" id="btn-add-library">Add</button>
            </div>
            <small>A list of sgRNA, one line for each name.</small><br>
            <small>Leave empty for Calabrese library autodetection.</small><br>
            <ul class="list-group" id="library-list">
            </ul>
          </div>
          <div class="mb-3">
            <button type="button" class="btn btn-primary" id="load-button" disabled>Load</button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/v/bs5/dt-1.13.4/b-2.3.6/b-colvis-2.3.6/b-html5-2.3.6/cr-1.6.2/sb-1.4.2/datatables.min.js"></script>
    <script
      src="https://cdn.plot.ly/plotly-2.20.0.min.js"
      charset="utf-8"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"
    ></script>
    <script type="text/javascript">    
//MAGECK_VIEW
var MGKV=function(){"use strict";class t{constructor(t=2e3){this.timeout=t,this.alertBox=$("<div></div>"),this.alertBox.addClass("fixed-bottom"),this.alertBox.css("width","100vw"),$("body").append(this.alertBox)}_initMessage(t,e){let a=$("<div></div>");a.addClass("alert alert-dismissible"),a.css("width","100vw"),a.css("margin-bottom","0"),a.css("margin-top","5px");let s=$("<span></span>");s.text(t);let o=$("<button></button>");o.addClass("btn-close"),o.click((t=>{a.remove()})),a.append(s),a.append(o),setTimeout((()=>{a.remove()}),this.timeout),a.addClass(e),this.alertBox.append(a)}warning(t){this._initMessage(t,"alert-warning")}error(t){this._initMessage(t,"alert-danger")}success(t){this._initMessage(t,"alert-success")}}class e{constructor(){}get ready(){return this.data.length>0}get hasLibrary(){return this.sgLibrary.length>0}data=[];sgLibrary=[];counts={};header=[];parseLibrary(t,e){return new Promise(((a,s)=>{let o=new FileReader,l="";o.onload=()=>{l+=o.result},o.readAsText(t),o.onloadend=()=>{let t,s={name:e,sgrnas:[]};l=l.split("\n");for(let e=0;e<l.length;e++)t=l[e].split("\t"),s.sgrnas.push(t[0]);this.sgLibrary.push(s),a(this.sgLibrary.length-1)}}))}parseSgCount(t){return new Promise(((e,a)=>{let s;this.counts={},t=t.split("\n");for(let e=0;e<t.length;e++)if(s=t[e].split("\t"),0==e){if("sgRNA"!=s[0]||"Gene"!=s[1])return void a("The input file is not a sgRNA count generated by MAGeCK.");this.samples=s.slice(2).map(((t,e)=>({name:t,order:e,group:void 0})))}else this.counts[s[0]]=s.slice(2).map((t=>parseFloat(t)));e()}))}mergeCountSummary(){return new Promise(((t,e)=>{this.hasLibrary?this.data.forEach((t=>{t.counts=this.counts[t.sgrna],t.library=this.sgLibrary.find((e=>e.sgrnas.includes(t.sgrna)))?.name})):this.data.forEach((t=>{t.counts=this.counts[t.sgrna],t.library=t.sgrna.match(/^[0-9]+$/)?"libA":"libB"})),this.counts=null,this.normalization_factors=this.computeNormalizationFactors(this.data),t()}))}_computeControlNormFactor(t){let e=t.filter((t=>t.gene==this.control_gene));return 0==e.length?Array(t[0].counts.length).fill(1):this._computeMedianNormFactor(e)}_computeMedianNormFactor(t){let e=t[0].counts.length,a=t.length,s=Array(a).fill(-1);t.forEach(((t,a)=>{t.counts.reduce(((t,e)=>t+e),0)>0&&(s[a]=Math.exp(1*t.counts.map((t=>Math.log(t+1))).reduce(((t,e)=>t+e),0)/e),s[a]<=0&&(s[a]=1))}));let o=Array(e).fill(0);for(let a=0;a<e;a++){let e=t.map(((t,e)=>t.counts[a]/s[e])).filter(((t,e)=>-1!=s[e])),l=e.sort()[Math.floor(e.length/2)];o[a]=l>0?1/l:0}return o}_computeTotalNormFactor(t){let e=t[0].counts.length;t.length;let a=Array(e).fill(0);t.forEach((t=>{t.counts.forEach(((t,e)=>a[e]+=t))}));let s=a.reduce(((t,e)=>t+e),0)/e;return a.map((t=>s/t))}computeNormalizationFactors(t){let e={};return e.raw=Array(t[0].counts.length).fill(1),e.total=this._computeTotalNormFactor(t),e.median=this._computeMedianNormFactor(t),e.control=this._computeControlNormFactor(t),e}parse(t){return new Promise(((e,a)=>{let s;this.data=[],t=t.split("\n");for(let e=0;e<t.length;e++)if(s=t[e].split("\t"),0==e){if("sgrna"!=s[0]||"Gene"!=s[1]||15!=s.length)return void a("The input file is not a single guide RNA Summary generated by MAGeCK.");this.header=s}else 15==s.length&&this.data.push({sgrna:s[0],gene:s[1],means:s.slice(4,6).map((t=>parseFloat(t))),LFC:parseFloat(s[6]),control_var:parseFloat(s[7]),adj_var:parseFloat(s[8]),score:parseFloat(s[9]),pLow:parseFloat(s[10]),pHigh:parseFloat(s[11]),pvalue:parseFloat(s[12]),FDR:parseFloat(s[13]),highInTreatment:"True"==s[14]});e()}))}}class a{constructor(){}data=[];header=[];_order=[];_selected=new Set;_prevPaging="";_prevSearch="";_prevOrder="";_prevColumns="";get ready(){return this.data.length>0}selectGene(t){this._selected.add(t)}deselectGene(t){this._selected.delete(t)}isSelected(t){return this._selected.has(t)}get nSelected(){return this._selected.size}async getData(t,e){let a={draw:t.draw,recordsTotal:this.data.length,recordsFiltered:0,data:[]};if(this._prevOrder!=JSON.stringify(t.order)){this._prevOrder=JSON.stringify(t.order),this._order=[...Array(this.data.length).keys()];let e=t.columns[t.order[0].column].data,a="asc"==t.order[0].dir?1:-1;e.includes(".")?(e=e.split("."),this._order.sort(((t,s)=>this.data[t][e[0]][e[1]]>this.data[s][e[0]][e[1]]?a:-a))):this._order.sort(((t,s)=>this.data[t][e]>this.data[s][e]?a:-a))}return a.data=this._order.slice(t.start,t.start+t.length).map((t=>this.data[t])),a.recordsFiltered=this._order.length,console.log(t),a}parse(t){return new Promise(((e,a)=>{let s;this.data=[],this.header=[],t=t.split("\n");for(let e=0;e<t.length;e++)if(s=t[e].split("\t"),0==e){if("id"!=s[0]||"num"!=s[1]||14!=s.length)return void a("The input file is not a gene Summary generated by MAGeCK.");this.header=s}else if(14==s.length){let t={gene:s[0],numSgRNA:parseInt(s[1]),neg:{score:parseFloat(s[2]),pvalue:parseFloat(s[3]),FDR:parseFloat(s[4]),rank:parseFloat(s[5]),good:parseInt(s[6]),LFC:parseFloat(s[7])},pos:{score:parseFloat(s[8]),pvalue:parseFloat(s[9]),FDR:parseFloat(s[10]),rank:parseFloat(s[11]),good:parseInt(s[12]),LFC:parseFloat(s[13])},best:"pos",rank:0};t.neg.pvalue==t.pos.pvalue?Math.abs(t.neg.LFC)>t.pos.LFC&&(t.best="neg"):t.neg.pvalue<t.pos.pvalue&&(t.best="neg"),t.LFC=t[t.best].LFC,t.pvalue=t[t.best].pvalue,t.FDR=t[t.best].FDR,this.data.push(t)}let o=[...Array(this.data.length).keys()];o=o.sort(((t,e)=>this.data[t].LFC>this.data[e].LFC?-1:1)),o.forEach(((t,e)=>{this.data[t].rank=e})),e()}))}}function s(t,e){var a=document.createElement("a");a.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),a.setAttribute("download",t),a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a)}const o="sgrna",l="sgrnaSummary",r="geneSummary";return class{constructor(s){this.root="string"==typeof s?$(s):s,this.root.addClass("visually-hidden"),this.root.append($("<div class='row'><div class='col-12'><h3>Genes summary</h3></div><div class='col-12'><table class='table table-striped table-bordered' id='mgkv-gene-table'></table></div></div>")),this.root.append($("<div class='row'><div class='col-12 mt-3'><h3>sgRNA summary</h3></div><div class='col-12'><table class='table table-striped table-bordered' id='mgkv-sg-table'></table></div></div>")),this.root.append($("<div class='row'><div class='col-12 mt-3'><h3>Plots </h3><small>click again on the plot button to refresh after changing options</small></div><div class='col-12'><div id='mgkv-plotly-buttons' class='btn-group'></div></div><div class='col-12 mt-2'><div id='mgkv-plotly-options'></div></div><div class='col-12'><div id='mgkv-plotly' style='min-height:80vh'></div></div></div>")),this._initSgBoxplot(),this._initVolcanoPlot(),this._initSgLinePlot(),this.alerts=new t,this.sgSummary=new e,this.gSummary=new a}geneTable=void 0;sgTable=void 0;selectedGene=[];normalization_factors=void 0;control_gene="NO-TARGET";_display_count_normalization="raw";afterInit=()=>{};parseLibrary(t,e){return this.sgSummary.parseLibrary(t,e)}get library(){return this.sgSummary.sgLibrary}parse(t,e){return new Promise(((a,s)=>{if(this._validInput(t.name,e)){let i=new FileReader,n="";i.onload=()=>{n+=i.result},i.readAsText(t),i.onloadend=()=>{let i;e==o&&(i=this.sgSummary.parseSgCount(n)),e==r&&(i=this.gSummary.parse(n)),e==l&&(i=this.sgSummary.parse(n)),i.then((e=>{this.alerts.success("File "+t.name+" imported correctly"),a(e)})).catch((t=>{console.log(t),this.alerts.error(t),s(t)}))}}else this.alerts.error("The file has an invalid name. Please, use the outputs of MAGeCK."),s("Invalid name")}))}load(){return new Promise(((t,e)=>{this.ready?(this.sgSummary.mergeCountSummary(),this._loading(!0).then((()=>{this._initTables().then((()=>{this._loading(!1).then(t)})).catch((t=>{e(t)}))}))):e("Not redy")}))}get ready(){return this.sgSummary.ready&&this.gSummary.ready}get samples(){return this.sgSummary.samples}_initSgBoxplot(){$("#mgkv-plotly-buttons").append("<button class='btn btn-primary' id='mgkv-boxplot-sgrna'>sgRNA boxplot</button>"),$("#mgkv-plotly-options").append("<div id='mgkv-plt-opts-sgb' class='btn-group mgkv-plt-opts row visually-hidden'><div class='col'><select class='form-select' id='mgkv-plt-opts-sgb-norm'><option value='raw' selected>Raw counts</option><option value='total'>Total normalization</option><option value='median'>Median normalization</option><option value='control'>Control normalization (equal median of NO-TARGET sgRNA)</option></select></div><div class='col'><select class='form-select' id='mgkv-plt-opts-sgb-scale'><option value='log10' selected>Log10</option><option value='linear'>Linear</option><option value='log2'>Log2</option></select></div></div>"),$("#mgkv-boxplot-sgrna").click((()=>{$("#mgkv-plotly-buttons>button").removeClass("active"),$("#mgkv-boxplot-sgrna").addClass("active"),$(".mgkv-plt-opts").addClass("visually-hidden"),$("#mgkv-plt-opts-sgb").removeClass("visually-hidden");let t={norm:"raw",scale:"log10"};t.norm=$("#mgkv-plt-opts-sgb-norm").val(),t.scale=$("#mgkv-plt-opts-sgb-scale").val(),this._sgBoxPlot(t)}))}_initSgLinePlot(){$("#mgkv-plotly-buttons").append("<button class='btn btn-primary' id='mgkv-line-sgrna'>sgRNA expression</button>"),$("#mgkv-plotly-options").append("<div id='mgkv-plt-opts-sgl' class='btn-group mgkv-plt-opts row visually-hidden'><div class='col'><select class='form-select' id='mgkv-plt-opts-sgl-norm'><option value='raw' selected>Raw counts</option><option value='total'>Total normalization</option><option value='median'>Median normalization</option><option value='control'>Control normalization (NO-TARGET sgRNA)</option></select></div><div class='col'><select class='form-select' id='mgkv-plt-opts-sgl-scale'><option value='log10' selected>Log10</option><option value='linear'>Linear</option><option value='log2'>Log2</option></select></div></div>"),$("#mgkv-line-sgrna").click((()=>{$("#mgkv-plotly-buttons>button").removeClass("active"),$("#mgkv-line-sgrna").addClass("active"),$(".mgkv-plt-opts").addClass("visually-hidden"),$("#mgkv-plt-opts-sgl").removeClass("visually-hidden");let t={norm:"raw",scale:"log10"};t.norm=$("#mgkv-plt-opts-sgl-norm").val(),t.scale=$("#mgkv-plt-opts-sgl-scale").val(),this._sgLinePlot(t)}))}_initVolcanoPlot(){$("#mgkv-plotly-buttons").append("<button class='btn btn-primary' id='mgkv-volcano-gene'>Genes Volcano Plot</button>"),$("#mgkv-plotly-buttons").append("<button class='btn btn-primary' id='mgkv-volcano-sg'>sgRNA Volcano Plot</button>"),$("#mgkv-plotly-options").append("<div id='mgkv-plt-opts-gvp' class='btn-group mgkv-plt-opts row visually-hidden'><div class='col'><select class='form-select' id='mgkv-plt-opts-gvp-y'><option value='pvalue' selected>Y axis value</option><option value='pvalue'>p-value</option><option value='FDR'>FDR</option></select></div><div class='col'><select class='form-select' id='mgkv-plt-opts-gvp-grp'><option value='best' selected>Test type</option><option value='best' title='Most significant between positive and negative p-value'>Best</option><option value='neg'>Negative</option><option value='pos'>Positive</option></select></div><div class='col'><div class='input-group'><span class='input-group-text'>Significance threshold</span><input class='form-control' id='mgkv-plt-opts-gvp-thr0' type='number' value='0.05' ></div></div><div class='col'><div class='input-group'><span class='input-group-text'>Absolute LogFC threshold</span><input class='form-control' id='mgkv-plt-opts-gvp-thr1' type='number' value='1.0' ></div></div><small>For performance reasons, only 10% of the Const data are shown.</small></div>"),$("#mgkv-plotly-options").append("<div id='mgkv-plt-opts-svp' class='btn-group mgkv-plt-opts row visually-hidden'><div class='col'><select class='form-select' id='mgkv-plt-opts-svp-y'><option value='pvalue' selected>Y axis value</option><option value='pvalue'>p-value</option><option value='FDR'>FDR</option><option value='pLow'>p-value low</option><option value='pHigh'>p-value high</option></select></div><div class='col'><div class='input-group'><span class='input-group-text'>Significance threshold</span><input class='form-control' id='mgkv-plt-opts-svp-thr0' type='number' value='0.05' ></div></div><div class='col'><div class='input-group'><span class='input-group-text'>Absolute LogFC threshold</span><input class='form-control' id='mgkv-plt-opts-svp-thr1' type='number' value='1.0' ></div></div><small>For performance reasons, only 10% of the Const data are shown.</small></div>"),$("#mgkv-volcano-gene").click((()=>{$("#mgkv-plotly-buttons>button").removeClass("active"),$("#mgkv-volcano-gene").addClass("active"),$(".mgkv-plt-opts").addClass("visually-hidden"),$("#mgkv-plt-opts-gvp").removeClass("visually-hidden");let t={value:"pvalue",group:"best",thr:[.05,1]};t.value=$("#mgkv-plt-opts-gvp-y").val(),t.group=$("#mgkv-plt-opts-gvp-grp").val(),t.thr[0]=parseFloat($("#mgkv-plt-opts-gvp-thr0").val()),t.thr[1]=parseFloat($("#mgkv-plt-opts-gvp-thr1").val()),this._geneVolcanoPlot(t)})),$("#mgkv-volcano-sg").click((()=>{$("#mgkv-plotly-buttons>button").removeClass("active"),$("#mgkv-volcano-sg").addClass("active"),$(".mgkv-plt-opts").addClass("visually-hidden"),$("#mgkv-plt-opts-svp").removeClass("visually-hidden");let t={value:"pvalue",thr:[.05,1]};t.value=$("#mgkv-plt-opts-svp-y").val(),t.group=$("#mgkv-plt-opts-svp-grp").val(),t.thr[0]=parseFloat($("#mgkv-plt-opts-svp-thr0").val()),t.thr[1]=parseFloat($("#mgkv-plt-opts-svp-thr1").val()),this._sgVolcanoPlot(t)}))}_validInput(t,e){return t.match(".*.count.txt$")&&e==o||t.match(".*.gene_summary.txt$")&&e==r||t.match(".*.sgrna_summary.txt$")&&e==l}datarevision=0;_plot(t,e){this.datarevision+=1,e.datarevision=this.datarevision,Plotly.react(document.getElementById("mgkv-plotly"),t,e)}_sgLinePlot(t){let e=Object.assign({norm:"raw",scale:"log10"},t);if(0==this.selectedGene.length)return void this._plot([],{title:"Select one or more gene to see the expression of their sgRNAs"});let a=[],s=this.selectedGene.map((t=>t.name));this.sgSummary.data.filter((t=>s.includes(t.gene))).forEach((t=>{let o=this.selectedGene.find((e=>e.name==t.gene)),l=s.indexOf(t.gene),r={x:[],y:[],order:l,name:t.sgrna+" ("+t.gene+")",type:"scatter",marker:{color:o.color,size:15},line:{color:o.color}};t.counts.forEach(((t,a)=>{r.x.push(this.samples[a].name);let s=this.sgSummary.normalization_factors[e.norm][a]*t;"log10"==e.scale?r.y.push(0==s?0:Math.log10(s)):"log2"==e.scale?r.y.push(0==s?0:Math.log2(s)):r.y.push(s)})),l>0&&(r.xaxis="x"+(l+1),r.yaxis="y"+(l+1)),a.push(r)}));let o={title:"sgRNA expression plot",xaxis:{title:s[0]},yaxis:{title:("linear"==e.scale?"":e.scale+" ")+("raw"==e.norm?"raw":e.norm+" normalized")+" counts"}};s.forEach(((t,e)=>{e>0&&(o["xaxis"+(e+1)]={title:t},o["yaxis"+(e+1)]={title:o.yaxis.title})})),s.length>1&&(o.grid={rows:s.length>2?Math.ceil(s.length/2):1,columns:2,pattern:"independent"}),a=a.sort(((t,e)=>t.order-e.order)),this._plot(a,o)}_sgBoxPlot(t){let e=Object.assign({norm:"raw",scale:"log10"},t),a=this.samples.map((t=>({y:[],name:t.name,order:t.order,type:"box"})));this.sgSummary.data.forEach((t=>{t.counts.forEach(((t,s)=>{let o=this.sgSummary.normalization_factors[e.norm][s]*t;"log10"==e.scale?a[s].y.push(0==o?0:Math.log10(o)):"log2"==e.scale?a[s].y.push(0==o?0:Math.log2(o)):a[s].y.push(o)}))})),a=a.sort(((t,e)=>t.order-e.order));let s={title:"sgRNA boxplot",xaxis:{title:"Sample"},yaxis:{title:("linear"==e.scale?"":e.scale+" ")+("raw"==e.norm?"raw":e.norm+" normalized")+" counts"}};this._plot(a,s)}_geneVolcanoPlot(t){let e=Object.assign({value:"pvalue",group:"best",thr:[.05,1]},t),a=e.thr[1],s=e.thr[0],o={title:"Genes Volcano Plot",xaxis:{title:"LogFC"},yaxis:{title:e.value}},l=[{mode:"markers",type:"scatter",x:[],y:[],text:[],name:"Neg",marker:{color:"#7CC6FE"}},{mode:"markers",type:"scatter",x:[],y:[],text:[],name:"Const",marker:{color:"#BFBFBF"}},{mode:"markers",type:"scatter",x:[],y:[],text:[],name:"Pos",marker:{color:"#FF7D83"}}];this.selectedGene.length>0&&this.selectedGene.forEach((t=>{l.push({mode:"markers+text",type:"scatter",x:[],y:[],text:[],name:t.name,textposition:"top center",marker:{color:t.color,size:14}})}));let r=1;this.gSummary.data.forEach((t=>{let o,i,n=t.gene;"best"==e.group?(o=t.LFC,i=t[e.value]):(o=t[e.group].LFC,i=t[e.group][e.value]),0!=i&&r>i&&(r=i);let d=this.selectedGene.findIndex((e=>e.name==t.gene));-1==d?d=i>s?1:o<-a?0:o>a?2:1:d+=3,(1!=d||Math.random()<.1)&&(l[d].x.push(o),l[d].y.push(0==i?-1:-Math.log10(i)),l[d].text.push(n))}));let i=-Math.log10(r);l.forEach((t=>{t.y=t.y.map((t=>-1==t?i:t))})),this._plot(l,o)}_sgVolcanoPlot(t){let e=Object.assign({value:"pvalue",thr:[.05,1]},t),a=e.thr[1],s=e.thr[0],o={title:"sgRNA Volcano Plot",xaxis:{title:"LogFC"},yaxis:{title:e.value}},l=[{mode:"markers",type:"scatter",x:[],y:[],text:[],name:"Neg",marker:{color:"#7CC6FE"}},{mode:"markers",type:"scatter",x:[],y:[],text:[],name:"Const",marker:{color:"#BFBFBF"}},{mode:"markers",type:"scatter",x:[],y:[],text:[],name:"Pos",marker:{color:"#FF7D83"}}];this.selectedGene.length>0&&this.selectedGene.forEach((t=>{l.push({mode:"markers+text",type:"scatter",x:[],y:[],text:[],name:t.name,textposition:"top center",marker:{color:t.color,size:14}})}));let r=1;this.sgSummary.data.forEach((t=>{let o,i,n=t.sgrna;o=t.LFC,i=t[e.value],0!=i&&r>i&&(r=i);let d=this.selectedGene.findIndex((e=>e.name==t.gene));-1==d?d=i>s?1:o<-a?0:o>a?2:1:d+=3,(1!=d||Math.random()<.1)&&(l[d].x.push(o),l[d].y.push(0==i?-1:-Math.log10(i)),l[d].text.push(n))}));let i=-Math.log10(r);l.forEach((t=>{t.y=t.y.map((t=>-1==t?i:t))})),this._plot(l,o)}_initTables(){return new Promise(((t,e)=>{if(!this.ready)return void e("Not ready");this.root.removeClass("visually-hidden"),this.geneTable&&this.geneTable.destroy(),this.sgTable&&this.sgTable.destroy(),$("#mgkv-gene-table").empty(),$("#mgkv-sg-table").empty(),this.geneTable=$("#mgkv-gene-table").DataTable({scrollY:"500px",scrollCollapse:!0,dom:"<'row'<'col-sm-12 mb-2'B>><'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>><'row'<'col-sm-12'tr>><'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",serverSide:!0,processing:!0,searchDelay:1e3,ajax:(t,e,a)=>{this.gSummary.getData(t,a).then((t=>{e(t)}))},colReorder:!0,rowId:"gene",buttons:["csv","colvis",{extend:"searchBuilder",config:{depthLimit:3}}],order:[[2,"desc"]],columns:[{title:"Gene",data:"gene",orderable:!0,searchable:!0},{title:"sgRNA",data:"numSgRNA",orderable:!0,searchable:!0},{title:"logFC",data:"LFC",orderable:!0,searchable:!0,visible:!0},{title:"FDR",data:"FDR",orderable:!0,searchable:!0,visible:!0},{title:"p-value",data:"pvalue",orderable:!0,searchable:!0,visible:!0},{title:"Rank",data:"rank",orderable:!0,searchable:!0,visible:!0},{title:"Neg score",data:"neg.score",orderable:!0,searchable:!0,visible:!1},{title:"Neg pvalue",data:"neg.pvalue",orderable:!0,searchable:!0,visible:!1},{title:"Neg FDR",data:"neg.FDR",orderable:!0,searchable:!0,visible:!1},{title:"Neg rank",data:"neg.rank",orderable:!0,searchable:!0,visible:!1},{title:"Neg good",data:"neg.good",orderable:!0,searchable:!0,visible:!1},{title:"Neg LFC",data:"neg.LFC",orderable:!0,searchable:!0,visible:!1},{title:"Pos score",data:"pos.score",orderable:!0,searchable:!0,visible:!1},{title:"Pos pvalue",data:"pos.pvalue",orderable:!0,searchable:!0,visible:!1},{title:"Pos FDR",data:"pos.FDR",orderable:!0,searchable:!0,visible:!1},{title:"Pos rank",data:"pos.rank",orderable:!0,searchable:!0,visible:!1},{title:"Pos good",data:"pos.good",orderable:!0,searchable:!0,visible:!1},{title:"Pos LFC",data:"pos.LFC",orderable:!0,searchable:!0,visible:!1}]});let a=[{title:"sgRNA",data:"sgrna",orderable:!0,searchable:!0},{title:"Library",data:"library",orderable:!0,searchable:!0},{title:"Gene",data:"gene",name:"gene",orderable:!0,searchable:!0},{title:"logFC",data:"LFC",orderable:!0,searchable:!0},{title:"Score",data:"score",orderable:!0,searchable:!0},{title:"p-value neg",data:"pLow",orderable:!0,searchable:!0,visible:!1},{title:"p-value pos",data:"pHigh",orderable:!0,searchable:!0,visible:!1},{title:"p-value",data:"pvalue",orderable:!0,searchable:!0},{title:"FDR",data:"FDR",orderable:!0,searchable:!0},{title:"Ctr. Var",data:"control_var",orderable:!0,searchable:!0,visible:!1},{title:"Adj. Var",data:"adj_var",orderable:!0,searchable:!0,visible:!1}];return this.samples.forEach(((t,e)=>{a.push({title:t.name,data:null,render:t=>Math.round(this.sgSummary.normalization_factors[this._display_count_normalization][e]*t.counts[e]*100)/100,orderable:!0,searchable:!0,visible:!0})})),this.sgTable=$("#mgkv-sg-table").DataTable({scrollY:"500px",scrollCollapse:!0,dom:"<'row'<'col-sm-12 mb-2'B>><'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>><'row'<'col-sm-12'tr>><'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",data:this.sgSummary.data,colReorder:!0,rowId:"sgrna",buttons:["csv","colvis","searchBuilder",{extend:"collection",text:"Count types",buttons:[{text:"raw",className:"raw"==this._display_count_normalization?"active norm-buttons":"norm-buttons",action:(t,e,a)=>{"raw"!=this._display_count_normalization&&($(".norm-buttons").removeClass("active"),a.addClass("active"),this._display_count_normalization="raw",e.rows().invalidate().draw(!1))}},{text:"Median normalized",className:"median"==this._display_count_normalization?"active norm-buttons":"norm-buttons",action:(t,e,a)=>{"median"!=this._display_count_normalization&&($(".norm-buttons").removeClass("active"),a.addClass("active"),this._display_count_normalization="median",e.rows().invalidate().draw(!1))}},{text:"Total normalized",className:"total"==this._display_count_normalization?"active norm-buttons":"norm-buttons",action:(t,e,a)=>{"total"!=this._display_count_normalization&&($(".norm-buttons").removeClass("active"),a.addClass("active"),this._display_count_normalization="total",e.rows().invalidate().draw(!1))}},{text:"Control normalized",className:"control"==this._display_count_normalization?"active norm-buttons":"norm-buttons",action:(t,e,a)=>{"control"!=this._display_count_normalization&&($(".norm-buttons").removeClass("active"),a.addClass("active"),this._display_count_normalization="control",e.rows().invalidate().draw(!1))}}]},{extend:"collection",text:"Download filtered count table",buttons:[{text:"Raw",action:(t,e)=>{let a="sgRNA\tGene\t"+this.samples.map((t=>t.name)).join("\t")+"\n";e.rows({search:"applied"}).data().toArray().forEach((t=>{a+=[t.sgrna,t.gene].concat(t.counts).join("\t")+"\n"})),s("raw.counts.txt",a)}},{text:"Median normalized",action:(t,e)=>{let a="sgRNA\tGene\t"+this.samples.map((t=>t.name)).join("\t")+"\n",o=e.rows({search:"applied"}).data().toArray(),l=this._computeMedianNormFactor(o);o.forEach((t=>{a+=[t.sgrna,t.gene].concat(t.counts.map(((t,e)=>Math.round(t*l[e]*100)/100))).join("\t")+"\n"})),s("median_normalized.counts.txt",a)}},{text:"Total normalized",action:(t,e)=>{let a="sgRNA\tGene\t"+this.samples.map((t=>t.name)).join("\t")+"\n",o=e.rows({search:"applied"}).data().toArray(),l=this._computeTotalNormFactor(o);o.forEach((t=>{a+=[t.sgrna,t.gene].concat(t.counts.map(((t,e)=>Math.round(t*l[e]*100)/100))).join("\t")+"\n"})),s("total_normalized.counts.txt",a)}},{text:"Control normalized",action:(t,e)=>{let a="sgRNA\tGene\t"+this.samples.map((t=>t.name)).join("\t")+"\n",o=e.rows({search:"applied"}).data().toArray(),l=this._computeControlNormFactor(o);o.forEach((t=>{a+=[t.sgrna,t.gene].concat(t.counts.map(((t,e)=>Math.round(t*l[e]*100)/100))).join("\t")+"\n"})),s("control_normalized.counts.txt",a)}}]}],order:[[3,"desc"]],columns:a}),$("#mgkv-gene-table tbody").on("click","tr",(t=>{let e=$(t.currentTarget),a=e.attr("id");this.gSummary.isSelected(a)?(this.gSummary.deselectGene(a),e.removeClass("selected")):(this.gSummary.selectGene(a),e.addClass("selected")),this._updateSelectedGene()})),$("#mgkv-boxplot-sgrna").click(),this.afterInit(),t(),!0}))}_updateSelectedGene(){this.sgTable.draw()}_loading(t=!0){return new Promise(((e,a)=>{t?$("body").append("<div id='mgkv-loading' class='position-absolute z-3 top-0 start-0 vh-100 vw-100 d-flex align-items-center justify-content-center bg-light'><div class='spinner-border text-success me-2' role='status'></div><h3>Loading the data</h3></div>"):$("#mgkv-loading").remove(),setTimeout(e,100)}))}}}();
//# sourceMappingURL=mageck.js.map
    </script>
    <script type="text/javascript">

      $(document).ready(function () {
        $("#mgkv-loading").remove();
        $("#main-container").removeClass("visually-hidden");
        let mgkv = new MGKV($("#mageckView"));
        mgkv.afterInit = () => {
          $("#file_loader").hide();
        };

        $("#btn-add-library").click(()=>{
          let el = document.getElementById("library-input-file")
          $("#library-input-name").removeClass("is-invalid")
          if ( el.files && el.files.length  == 1 ){
            let libName = $("#library-input-name").val()
            let file = el.files[0]
            if ( libName.length > 0 ){
              mgkv.parseLibrary(file, libName).then((idx)=>{
                $("#library-input-name").removeClass("is-invalid")  
                $("#library-list").append("<li class='list-group-item'>"+libName+" ("+mgkv.library[idx].sgrnas.length+" sgRNAs) <button class='btn btn-sm btn-outline-danger float-end library-remover' data-idx='"+idx+"'><i><i class='bi bi-trash'></i></i></button> </li>")
              });
            } else {
              $("#library-input-name").addClass("is-invalid")
              $(el).val(undefined)
            }
          }
        })
        $("#library-list").on("click","button",(el)=>{
          let libIdx = parseInt($(el.currentTarget).attr("data-idx"))
          mgkv.library.splice(libIdx, 1);
          $(el.currentTarget).parent().remove();
        })
       
        let fls = $("input.mkgv-file-loader");
        if ( mgkv.hasLibrary ){
          $("#library-input").addClass('is-valid');
        }
        let loadFile = (el) => {
          let data_type = $(el).attr("data-type");
          if (data_type && el.files && el.files.length == 1) {
            mgkv.parse(
              el.files[0],
              data_type).then(()=>{
                $(el).removeClass("is-invalid");
                $(el).addClass("is-valid");
                if ( mgkv.ready ){
                  $("#load-button").attr("disabled", false)
                }
              }).catch((err)=>{
                $(el).removeClass("is-valid");
                $(el).addClass("is-invalid");
                $(el).val(undefined)
              });
          }
        };

        for (let i = 0; i < fls.length; i++) {
          loadFile(fls.get(i));
        }
        

        $("input.mkgv-file-loader").change((e) => {
          loadFile(e.target);
        });
        $("#load-button").click(()=>{
          mgkv.load();
        })

      });


      
    </script>
  </body>
</html>
